}
disbayes_input_list_city_regions_3b <-  list.clean(disbayes_input_list_city_regions_3b, fun = is.null, recursive = TRUE)
disbayes_input_list_city_regions_3b[[899]]
disbayes_input_list_city_regions_3b[[1282]]
disbayes_input_list_city_regions_3b[[1281]]
View(disbayes_input_list_city_regions_3)
disbayes_input_list_city_regions_3b <-  list.clean(disbayes_input_list_city_regions_3b, fun = is.null, recursive = TRUE)
View(disbayes_input_list_city_regions_3b)
disbayes_input_list_city_regions_3b[[1281]]
disbayes_input_list_city_regions_3b[[1282]]
disbayes_input_list_city_regions_3[[1282]]
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(disbayes_input_list_city_regions_3[[index]] != is.list) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(disbayes_input_list_city_regions_3[[index]] != is.list(disbayes_input_list_city_regions_3[[index]])) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
disbayes_input_list_city_regions_3[[1282]]
inherits(data.frame(disbayes_input_list_city_regions_3[[1]]), "list")
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[[index]]), "list") == TRUE) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
not_data_frame <- c(inherits(data.frame(disbayes_input_list_city_regions_3[[index]]), "list") == TRUE) %>% as.character()
not_data_frame <- c(inherits(data.frame(disbayes_input_list_city_regions_3), "list") == TRUE) %>% as.character()
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[[index]]), "list") == "TRUE") {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
inherits(data.frame(disbayes_input_list_city_regions_3[[1]]), "list")
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[[i]]), "list") == TRUE) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
#### Try to remove if not data frame
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(disbayes_input_list_city_regions_3[[i]], "list") == TRUE) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
View(disbayes_input_list_city_regions_3b)
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(disbayes_input_list_city_regions_3[[i]], "list") == FALSE) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
inherits(data.frame(disbayes_input_list_city_regions_3[[1]]), "list")
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[[i]], "list") == FALSE)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
inherits(data.frame(disbayes_input_list_city_regions_3, "list")) == FALSE
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[i], "list") == FALSE)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(inherits(data.frame(disbayes_input_list_city_regions_3[i], "list") == TRUE)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(length(disbayes_input_list_city_regions_3[i] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(length(disbayes_input_list_city_regions_3[[i]] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(ncol(disbayes_input_list_city_regions_3[[i]] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
disbayes_input_list_city_regions_3[1]
disbayes_input_list_city_regions_3[[1]
disbayes_input_list_city_regions_3[[1]]
disbayes_input_list_city_regions_3[[1]]
disbayes_input_list_city_regions_3[1]
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(ncol(disbayes_input_list_city_regions_3[[i]] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
ncol(disbayes_input_list_city_regions_3[[1]])
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(ncol(disbayes_input_list_city_regions_3[[i]] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(NCOL(disbayes_input_list_city_regions_3[[i]] != 4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(NCOL(disbayes_input_list_city_regions_3[[i]]) != as.numertic(4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(NCOL(disbayes_input_list_city_regions_3[[i]]) != as.numeric(4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
disbayes_input_list_city_regions_3b <- list()
index <- 1
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(NCOL(disbayes_input_list_city_regions_3[[i]]) != as.numeric(4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
View(disbayes_input_list_city_regions_3b)
disbayes_input_list_city_regions_3b <-  list.clean(disbayes_input_list_city_regions_3b, fun = is.null, recursive = TRUE)
View(disbayes_input_list_city_regions_3b)
disbayes_input_list_city_regions_4 <- disbayes_input_list_city_regions_3b %>% lapply(as.data.frame)
disbayes_input_list_city_regions_5 <- disbayes_input_list_city_regions_4 %>% summarise_all(funs(sum))
disbayes_input_list_city_regions_4 <- disbayes_input_list_city_regions_3b %>% lapply(as.data.frame)
disbayes_input_list_city_regions_4 <- disbayes_input_list_city_regions_3b %>% lapply(as.data.frame) %>% bind_rows() %>% group_by(indexagg)
warnings()
disbayes_input_list_city_regions_5 <- disbayes_input_list_city_regions_4 %>% summarise_all(funs(sum))
disbayes_input_list_city_regions_5$indexagg <- gsub("'", '', disbayes_input_list_city_regions_5$indexagg)
disbayes_input_list_city_regions_6 <- disbayes_input_list_city_regions_5 %>%  mutate_if(is.character, RemoveAllWs)%>%
mutate(index = indexagg) %>%
separate(indexagg, c("measure", "disease", "sex", "age", "cityregion"))
disbayes_input_list_city_regions_6$agegr <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="Under5"] <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="5to9"] <- 5
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="10to14"] <- 10
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="15to19"] <- 15
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="20to24"] <- 20
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="25to29"] <- 25
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="30to34"] <- 30
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="35to39"] <- 35
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="40to44"] <- 40
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="45to49"] <- 45
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="50to54"] <- 50
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="55to59"] <- 55
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="60to64"] <- 60
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="65to69"] <- 65
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="70to74"] <- 70
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="75to79"] <- 75
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="80to84"] <- 80
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="85to89"] <- 85
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="90to94"] <- 90
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="95plus"] <- 95
city_regions_names <- unique(disbayes_input_list_city_regions_6$cityregion)
disease_disbayes <- unique(disbayes_input_list_city_regions_6$disease)
measure_disbayes <- unique(disbayes_input_list_city_regions_6$measure)
sex_disbayes <- unique(disbayes_input_list_city_regions_6$sex)
## To wider
disbayes_input_list_city_regions_7 <- disbayes_input_list_city_regions_6 %>%
pivot_wider(id_cols = c(agegr, sex, population_number, cityregion, measure, disease),
names_from = measure, values_from = c(num, denom))
## Create list
index <- 1
disbayes_input_list2 <- list()
for (c in city_regions_names){
for (d in disease_disbayes){
for (s in sex_disbayes){
disbayes_input_list2[[index]] <- dplyr::filter(disbayes_input_list_city_regions_7, cityregion == c, disease == d, sex == s)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][order(disbayes_input_list2[[index]]$agegr),]
outage <- 0:100  # assume num and denom are the same in each year within a five-year age group
#
ind <- findInterval(outage, disbayes_input_list2[[index]]$agegr)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][ind,]
disbayes_input_list2[[index]]$age <- outage
### It leaves NA values (I need to have all columns filled in)
disbayes_input_list2[[index]]$index <- tolower(paste(disbayes_input_list2[[index]]$sex,
disbayes_input_list2[[index]]$disease,
disbayes_input_list2[[index]]$age,
disbayes_input_list2[[index]]$cityregion, sep = "_"))
# disbayes_input_list2[[index]] <- disbayes_input_list2[[index]] %>% pivot_wider(id_cols = c(index), names_from = measure, values_from = c(num, denom))
index <- index + 1
}
}
}
# ---- chunk-1.2.6: Join dataframes with all disbayes inputs ----
## First data set rates
disbayes_inputs_df <- do.call(rbind, disbayes_input_list_city_regions)
### Some issue with disease column, which we do not need, to rbind to dataframe
disbayes_inputs_df <- lapply(disbayes_inputs_df, function(x) { x["disease"] <- NULL; x })
disbayes_inputs_df <- dplyr::bind_rows(disbayes_inputs_df)
### CHECK WHAT HAPPENEND WITH CITY REGIONS AND THATN INDEX IS THE SAME AS IN DISBAYES INPUT DATAFRAME2
disbayes_inputs_df$index <- paste(disbayes_inputs_df$sex_disease, disbayes_inputs_df$age, disbayes_inputs_df$cityregion, sep = "_")
## Second data set with num and denom
disbayes_inputs_df2 <- do.call(rbind, disbayes_input_list2)
disbayes_inputs_df2 <-   disbayes_inputs_df2[ -c(1:5,10) ]
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(sex_disease, c("drop", "disease"))
disbayes_inputs <- disbayes_inputs[, !(colnames(disbayes_inputs ) %in% c("drop","index"))]
disbayes_input_list_city_regions_5 <- disbayes_input_list_city_regions_4 %>% summarise_all(funs(sum))
disbayes_input_list_city_regions_5$indexagg <- gsub("'", '', disbayes_input_list_city_regions_5$indexagg)
disbayes_input_list_city_regions_6 <- disbayes_input_list_city_regions_5 %>%  mutate_if(is.character, RemoveAllWs)%>%
mutate(index = indexagg) %>%
separate(indexagg, c("measure", "disease", "sex", "age", "cityregion"))
disbayes_input_list_city_regions_6$agegr <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="Under5"] <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="5to9"] <- 5
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="10to14"] <- 10
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="15to19"] <- 15
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="20to24"] <- 20
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="25to29"] <- 25
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="30to34"] <- 30
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="35to39"] <- 35
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="40to44"] <- 40
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="45to49"] <- 45
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="50to54"] <- 50
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="55to59"] <- 55
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="60to64"] <- 60
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="65to69"] <- 65
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="70to74"] <- 70
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="75to79"] <- 75
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="80to84"] <- 80
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="85to89"] <- 85
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="90to94"] <- 90
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="95plus"] <- 95
city_regions_names <- unique(disbayes_input_list_city_regions_6$cityregion)
disease_disbayes <- unique(disbayes_input_list_city_regions_6$disease)
measure_disbayes <- unique(disbayes_input_list_city_regions_6$measure)
sex_disbayes <- unique(disbayes_input_list_city_regions_6$sex)
disbayes_input_list_city_regions_7 <- disbayes_input_list_city_regions_6 %>%
pivot_wider(id_cols = c(agegr, sex, population_number, cityregion, measure, disease),
names_from = measure, values_from = c(num, denom))
View(disbayes_input_list_city_regions_7)
disbayes_input_list_city_regions_4 <- disbayes_input_list_city_regions_3b %>% lapply(as.data.frame) %>% bind_rows() %>% group_by(indexagg)
disbayes_input_list_city_regions_5 <- disbayes_input_list_city_regions_4 %>% summarise_all(funs(sum))
disbayes_input_list_city_regions_5$indexagg <- gsub("'", '', disbayes_input_list_city_regions_5$indexagg)
disbayes_input_list_city_regions_6 <- disbayes_input_list_city_regions_5 %>%  mutate_if(is.character, RemoveAllWs)%>%
mutate(index = indexagg) %>%
separate(indexagg, c("measure", "disease", "sex", "age", "cityregion"))
View(disbayes_input_list_city_regions_6)
View(disbayes_input_list_city_regions_5)
View(disbayes_input_list_city_regions_6)
View(disbayes_input_list_city_regions_7)
disbayes_input_list_city_regions_2 <- list()
index <- 1
for (i in 1:length(gbd_city_region_data)) {
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(DISEASE_SHORT_NAMES)){
in_measure <- disease_measures_list[dm] %>% as.character() %>% tolower()
### exclude ylds for now, we are interested in disbayes inputs but later may use ylds uncertainty parameters
if (DISEASE_SHORT_NAMES$is_not_dis[d] != 0 || in_measure == "ylds (years lived with disability)"){
}
else {
med <- paste0(in_measure, "_med_", DISEASE_SHORT_NAMES$sname[d])
low <- paste0(in_measure, "_lower95_", DISEASE_SHORT_NAMES$sname[d])
upper <- paste0(in_measure, "_upper95_", DISEASE_SHORT_NAMES$sname[d])
## These data is in 5-year age groups.
data <- gbd_city_region_data[[i]]
disbayes_input_list_city_regions_2[[index]] <- dplyr::select(data, population_number, cityregion, location, sex_age_cat, med, low, upper)
disbayes_input_list_city_regions_2[[index]]$est <- disbayes_input_list_city_regions_2[[index]][[med]]/disbayes_input_list_city_regions_2[[index]][[1]]
disbayes_input_list_city_regions_2[[index]]$lower <- disbayes_input_list_city_regions_2[[index]][[low]]/disbayes_input_list_city_regions_2[[index]][[1]]
disbayes_input_list_city_regions_2[[index]]$upper <- disbayes_input_list_city_regions_2[[index]][[upper]]/disbayes_input_list_city_regions_2[[index]][[1]]
disbayes_input_list_city_regions_2[[index]]$index <- paste(in_measure, DISEASE_SHORT_NAMES$sname[d], sep = "_")
disbayes_input_list_city_regions_2[[index]]$indexagg <- paste(disbayes_input_list_city_regions_2[[index]]$index, disbayes_input_list_city_regions_2[[index]]$sex_age_cat,
disbayes_input_list_city_regions_2[[index]]$cityregion, sep = "_")
## Separate age and sex and
suppressWarnings(names(disbayes_input_list_city_regions_2)[index] <- paste(gbd_city_region_data[[i]]$cityregion,in_measure, DISEASE_SHORT_NAMES$sname[d], sep = '_'))
index <- index + 1
}
}
}
}
View(disbayes_input_list_city_regions_2)
tryCatchCi2NumDF <- function(x) tryCatch(Ci2NumDF(x), error = function(e) e)
disbayes_input_list_city_regions_3  <- lapply(disbayes_input_list_city_regions_2, tryCatchCi2NumDF)
index <- 1
disbayes_input_list_city_regions_3b <- list()
for (i in 1:length(disbayes_input_list_city_regions_3)) {
if(NCOL(disbayes_input_list_city_regions_3[[i]]) != as.numeric(4)) {}
else{
disbayes_input_list_city_regions_3b[[index]] <- disbayes_input_list_city_regions_3[[i]]
}
index <- index + 1
}
disbayes_input_list_city_regions_3b <-  list.clean(disbayes_input_list_city_regions_3b, fun = is.null, recursive = TRUE)
disbayes_input_list_city_regions_4 <- disbayes_input_list_city_regions_3b %>% lapply(as.data.frame) %>% bind_rows() %>% group_by(indexagg)
disbayes_input_list_city_regions_5 <- disbayes_input_list_city_regions_4 %>% summarise_all(funs(sum))
disbayes_input_list_city_regions_5$indexagg <- gsub("'", '', disbayes_input_list_city_regions_5$indexagg)
disbayes_input_list_city_regions_6 <- disbayes_input_list_city_regions_5 %>%  mutate_if(is.character, RemoveAllWs)%>%
mutate(index = indexagg) %>%
separate(indexagg, c("measure", "disease", "sex", "age", "cityregion"))
disbayes_input_list_city_regions_6$agegr <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="Under5"] <- 0
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="5to9"] <- 5
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="10to14"] <- 10
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="15to19"] <- 15
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="20to24"] <- 20
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="25to29"] <- 25
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="30to34"] <- 30
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="35to39"] <- 35
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="40to44"] <- 40
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="45to49"] <- 45
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="50to54"] <- 50
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="55to59"] <- 55
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="60to64"] <- 60
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="65to69"] <- 65
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="70to74"] <- 70
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="75to79"] <- 75
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="80to84"] <- 80
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="85to89"] <- 85
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="90to94"] <- 90
disbayes_input_list_city_regions_6$agegr [ disbayes_input_list_city_regions_6$age =="95plus"] <- 95
city_regions_names <- unique(disbayes_input_list_city_regions_6$cityregion)
disease_disbayes <- unique(disbayes_input_list_city_regions_6$disease)
measure_disbayes <- unique(disbayes_input_list_city_regions_6$measure)
sex_disbayes <- unique(disbayes_input_list_city_regions_6$sex)
disbayes_input_list_city_regions_7 <- disbayes_input_list_city_regions_6 %>%
pivot_wider(id_cols = c(agegr, sex, population_number, cityregion, measure, disease),
names_from = measure, values_from = c(num, denom))
index <- 1
disbayes_input_list2 <- list()
for (c in city_regions_names){
for (d in disease_disbayes){
for (s in sex_disbayes){
disbayes_input_list2[[index]] <- dplyr::filter(disbayes_input_list_city_regions_7, cityregion == c, disease == d, sex == s)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][order(disbayes_input_list2[[index]]$agegr),]
outage <- 0:100  # assume num and denom are the same in each year within a five-year age group
#
ind <- findInterval(outage, disbayes_input_list2[[index]]$agegr)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][ind,]
disbayes_input_list2[[index]]$age <- outage
### It leaves NA values (I need to have all columns filled in)
disbayes_input_list2[[index]]$index <- tolower(paste(disbayes_input_list2[[index]]$sex,
disbayes_input_list2[[index]]$disease,
disbayes_input_list2[[index]]$age,
disbayes_input_list2[[index]]$cityregion, sep = "_"))
# disbayes_input_list2[[index]] <- disbayes_input_list2[[index]] %>% pivot_wider(id_cols = c(index), names_from = measure, values_from = c(num, denom))
index <- index + 1
}
}
}
## First data set rates
disbayes_inputs_df <- do.call(rbind, disbayes_input_list_city_regions)
disbayes_inputs_df <- lapply(disbayes_inputs_df, function(x) { x["disease"] <- NULL; x })
disbayes_inputs_df <- dplyr::bind_rows(disbayes_inputs_df)
disbayes_inputs_df$index <- paste(disbayes_inputs_df$sex_disease, disbayes_inputs_df$age, disbayes_inputs_df$cityregion, sep = "_")
## Second data set with num and denom
disbayes_inputs_df2 <- do.call(rbind, disbayes_input_list2)
disbayes_inputs_df2 <-   disbayes_inputs_df2[ -c(1:5,10) ]
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(sex_disease, c("drop", "disease"))
disbayes_inputs <- disbayes_inputs[, !(colnames(disbayes_inputs ) %in% c("drop","index"))]
write_rds(disbayes_inputs, paste0(relative_path_mslt, "data/city regions/Input disbayes/disbayes_inputs", ".rds"))
View(disbayes_inputs)
disbayes_input_list_city_regions_7 <- disbayes_input_list_city_regions_6 %>%
pivot_wider(id_cols = c(agegr, sex, population_number, cityregion, measure, disease),
names_from = measure, values_from = c(num, denom))
index <- 1
disbayes_input_list2 <- list()
for (c in city_regions_names){
for (d in disease_disbayes){
for (s in sex_disbayes){
disbayes_input_list2[[index]] <- dplyr::filter(disbayes_input_list_city_regions_7, cityregion == c, disease == d, sex == s)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][order(disbayes_input_list2[[index]]$agegr),]
outage <- 0:100  # assume num and denom are the same in each year within a five-year age group
#
ind <- findInterval(outage, disbayes_input_list2[[index]]$agegr)
disbayes_input_list2[[index]] <- disbayes_input_list2[[index]][ind,]
disbayes_input_list2[[index]]$age <- outage
### It leaves NA values (I need to have all columns filled in)
disbayes_input_list2[[index]]$index <- tolower(paste(disbayes_input_list2[[index]]$sex,
disbayes_input_list2[[index]]$disease,
disbayes_input_list2[[index]]$age,
disbayes_input_list2[[index]]$cityregion, sep = "_"))
# disbayes_input_list2[[index]] <- disbayes_input_list2[[index]] %>% pivot_wider(id_cols = c(index), names_from = measure, values_from = c(num, denom))
index <- index + 1
}
}
}
## First data set rates
disbayes_inputs_df <- do.call(rbind, disbayes_input_list_city_regions)
### Some issue with disease column, which we do not need, to rbind to dataframe
disbayes_inputs_df <- lapply(disbayes_inputs_df, function(x) { x["disease"] <- NULL; x })
disbayes_inputs_df <- dplyr::bind_rows(disbayes_inputs_df)
### CHECK WHAT HAPPENEND WITH CITY REGIONS AND THATN INDEX IS THE SAME AS IN DISBAYES INPUT DATAFRAME2
disbayes_inputs_df$index <- paste(disbayes_inputs_df$sex_disease, disbayes_inputs_df$age, disbayes_inputs_df$cityregion, sep = "_")
### CHECK WHAT HAPPENEND WITH CITY REGIONS AND THATN INDEX IS THE SAME AS IN DISBAYES INPUT DATAFRAME2
disbayes_inputs_df$index <- paste(disbayes_inputs_df$sex_disease, disbayes_inputs_df$age_cat, disbayes_inputs_df$cityregion, sep = "_")
## Second data set with num and denom
disbayes_inputs_df2 <- do.call(rbind, disbayes_input_list2)
View(disbayes_inputs_df2)
View(disbayes_inputs_df2)
View(disbayes_inputs_df2)
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(sex_disease, c("drop", "disease"))
disbayes_inputs_df <- dplyr::bind_rows(disbayes_inputs_df)
### CHECK WHAT HAPPENEND WITH CITY REGIONS AND THATN INDEX IS THE SAME AS IN DISBAYES INPUT DATAFRAME2
disbayes_inputs_df$index <- paste(disbayes_inputs_df$sex_disease, disbayes_inputs_df$age_cat, disbayes_inputs_df$cityregion, sep = "_")
## Second data set with num and denom
disbayes_inputs_df2 <- do.call(rbind, disbayes_input_list2)
disbayes_inputs_df2 <-   disbayes_inputs_df2[ -c(1:2,4,5,12) ]
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(sex_disease, c("drop", "disease"))
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(index, c("sex", "disease", "age", "cityregion"))
## Final data set to process in disbayes. Filter data by city region, disease and sex. COMPARE with saved data in rds
disbayes_inputs <- disbayes_inputs_df %>%
left_join(disbayes_inputs_df2) %>%
separate(sex_disease, c("drop", "disease"))
disbayes_inputs <- disbayes_inputs[, !(colnames(disbayes_inputs ) %in% c("drop","index"))]
colname(disbayes_inputs[which(names(disabyes_inputs =="age_cat")]) <- "age"
colname(disbayes_inputs)[which(names(disabyes_inputs =="age_cat"))] <- "age"
colnames(disbayes_inputs)[which(names(disabyes_inputs =="age_cat"))] <- "age"
colnames(disbayes_inputs)[which(names(disbyes_inputs =="age_cat"))] <- "age"
colnames(disbayes_inputs)[which(names(disbayes_inputs =="age_cat"))] <- "age"
write_rds(disbayes_inputs, paste0(relative_path_mslt, "data/city regions/Input disbayes/disbayes_inputs", ".rds"))
disbayes_inputs <- readRDS("C:/Metahit/mh-mslt/data/city regions/Input disbayes/disbayes_inputs.rds")
disbayes_inputs_original <- readRDS("C:/Metahit/mh-mslt/data/city regions/Input disbayes/disbayes_inputs_original.rds")
disbayes_inputs_original <- readRDS("C:/Metahit/mh-mslt/data/city regions/Input disbayes/disbayes_inputs_original.rds")
compare_old <- dplyr::filter(disbayes_inputs, sex == "male", disease == "crdd", cityregion == "bristol")
compare_new <- dplyr::filter(disbayes_inputs_original, sex == "male", disease == "crdd", cityregion == "bristol")
View(compare_new)
View(compare_old)
compare_new$pop - compare_new$pop
compare_new$inc - compare_new$inc
compare_new$prev - compare_new$iprev
compare_new$prev - compare_new$prev
compare_new$num_deaths - compare_new$num_deaths
compare_new$num_incidence - compare_new$num_incidence
