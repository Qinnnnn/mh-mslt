population_numbers <- dplyr::filter(idf, metric == "Number") %>% dplyr::select("val", "lower", "upper")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% dplyr::select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0)
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% dplyr::select("val", "lower", "upper")
#, "lower", "upper")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% dplyr::select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", DISEASE_SHORT_NAMES$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "med", DISEASE_SHORT_NAMES$sname[d], sep = "_"))]] <- current_population_numbers$val
idf[[tolower(paste(dmeasure, "lower95", DISEASE_SHORT_NAMES$sname[d], sep = "_"))]] <- current_population_numbers$lower
idf[[tolower(paste(dmeasure, "upper95", DISEASE_SHORT_NAMES$sname[d], sep = "_"))]] <- current_population_numbers$upper
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- dplyr::select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 2], names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
names(idf)[ncol(idf)]
names(idf)[ncol(idf) - 1]
}
else{
age_sex_df <- cbind(age_sex_df, dplyr::select(idf, names(idf)[ncol(idf) - 2], names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
# browser()
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
gbd_df$sex_age_cat <- paste0(gbd_df$sex, gbd_df$age, sep = "_")
## Add numberical age categories
gbd_df$age_cat <- 0
gbd_df$age_cat [ gbd_df$age =="Under 5"] <- 2
gbd_df$age_cat [ gbd_df$age =="5 to 9"] <- 7
gbd_df$age_cat [ gbd_df$age =="10 to 14"] <- 12
gbd_df$age_cat [ gbd_df$age =="15 to 19"] <- 17
gbd_df$age_cat [ gbd_df$age =="20 to 24"] <- 22
gbd_df$age_cat [ gbd_df$age =="25 to 29"] <- 27
gbd_df$age_cat [ gbd_df$age =="30 to 34"] <- 32
gbd_df$age_cat [ gbd_df$age =="35 to 39"] <- 37
gbd_df$age_cat [ gbd_df$age =="40 to 44"] <- 42
gbd_df$age_cat [ gbd_df$age =="45 to 49"] <- 47
gbd_df$age_cat [ gbd_df$age =="50 to 54"] <- 52
gbd_df$age_cat [ gbd_df$age =="55 to 59"] <- 57
gbd_df$age_cat [ gbd_df$age =="60 to 64"] <- 62
gbd_df$age_cat [ gbd_df$age =="65 to 69"] <- 67
gbd_df$age_cat [ gbd_df$age =="70 to 74"] <- 72
gbd_df$age_cat [ gbd_df$age =="75 to 79"] <- 77
gbd_df$age_cat [ gbd_df$age =="80 to 84"] <- 82
gbd_df$age_cat [ gbd_df$age =="85 to 89"] <- 87
gbd_df$age_cat [ gbd_df$age =="90 to 94"] <- 92
gbd_df$age_cat [ gbd_df$age =="95 plus"] <- 97
## Change sex variable to lower case
gbd_df$sex <- tolower(gbd_df$sex)
## Create age_sex category
gbd_df$sex_age_cat <- paste(gbd_df$sex,gbd_df$age_cat, sep = "_"  )
## Order data
gbd_df <- gbd_df[order(gbd_df$sex, gbd_df$age_cat),]
}
}
}
# ## Calculate rates per one. Needed for mslt_code
for (d in 1:nrow(DISEASE_SHORT_NAMES)){
for (dm in 1:length(disease_measures_list)){
# dn <- DISEASE_SHORT_NAMES$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character() %>% tolower
var_rate <- c(paste(tolower(paste(dmeasure, "rate", DISEASE_SHORT_NAMES$sname[d], sep = "_"))))
var_med <- c(paste(tolower(paste(dmeasure, "med", DISEASE_SHORT_NAMES$sname[d], sep = "_"))))
gbd_df[[var_rate]] <- gbd_df[[var_med]] /
gbd_df$population_number
}
}
return(gbd_df)
}
### GenLTDF creates dataframe in one year age (mortality rates)
GenLTDF <- function(i_data) {
lt_df <- data.frame(age = rep(c(0:100), 2), sex = append(rep("male", 101),
rep("female", 101)))
## Add age groups for cohort modelling
lt_df$age_cat [lt_df$age == 2] <- 2
lt_df$age_cat [lt_df$age == 7] <- 7
lt_df$age_cat [lt_df$age == 12] <- 12
lt_df$age_cat [lt_df$age == 17] <- 17
lt_df$age_cat [lt_df$age == 22] <- 22
lt_df$age_cat [lt_df$age == 27] <- 27
lt_df$age_cat [lt_df$age == 32] <- 32
lt_df$age_cat [lt_df$age == 37] <- 37
lt_df$age_cat [lt_df$age == 42] <- 42
lt_df$age_cat [lt_df$age == 47] <- 47
lt_df$age_cat [lt_df$age == 52] <- 52
lt_df$age_cat [lt_df$age == 57] <- 57
lt_df$age_cat [lt_df$age == 62] <- 62
lt_df$age_cat [lt_df$age == 67] <- 67
lt_df$age_cat [lt_df$age == 72] <- 72
lt_df$age_cat [lt_df$age == 77] <- 77
lt_df$age_cat [lt_df$age == 82] <- 82
lt_df$age_cat [lt_df$age == 87] <- 87
lt_df$age_cat [lt_df$age == 92] <- 92
lt_df$age_cat [lt_df$age == 97] <- 97
lt_df$sex_age_cat <- paste(lt_df$sex, lt_df$age, sep = "_"  )
gbd_popn_df <- dplyr::select(i_data, population_number, sex_age_cat)
lt_df <- left_join(lt_df, gbd_popn_df)
### Interpolate rates from 5 year age groups to 1
lt_df$mx <- 1
index <- 1
for(sex_index in c("male", "female")) {
var_name1 <- "deaths_rate_allc"
data <- dplyr::filter(i_data, sex == sex_index) %>% dplyr::select(age, sex, age_cat, sex_age_cat, var_name1)
x <- data$age_cat
y <- log(data[[var_name1]])
InterFunc <- stats::splinefun(x, y, method = "monoH.FC", ties = mean)
interpolated <- as.data.frame(InterFunc(seq(0, 100, 1)))
age <- seq(0, 100, by = 1)
interpolated <- cbind(interpolated, age)
interpolated[,1] <- exp(interpolated[,1])
## Add column with sex to create age_sex category to then merge with input_life table
interpolated$sex <- paste(sex_index)
interpolated$sex_age_cat <- paste(interpolated$sex, interpolated$age, sep = "_")
## Change name of column death to mx and ylds to pyld_rate to then merge
## with input_life table
colnames(interpolated)[1] <- var_name1
lt_df[lt_df$sex_age_cat == interpolated$sex_age_cat
& lt_df$sex == sex_index, ][["mx"]] <- interpolated[[var_name1]]
index <- index + 1
}
return(lt_df)
}
### RunLife
RunLifeTable <- function(in_idata, in_sex, in_mid_age)
{
# Create a life table starting data frame from input data.
lf_df <- in_idata[in_idata$age >= in_mid_age & in_idata$sex == in_sex,]
lf_df <- lf_df[,colnames(lf_df) %in% c('sex', 'age', 'mx')]
# Create list life table variables. First as vector and then added to the data frame at the end.
## We model up to 100, that is the reason for the age limit in the function
# probability of dying
qx <-  ifelse(lf_df$age < 100, 1 - exp(-1 * lf_df$mx), 1)
# number of survivors year 1 simulation
num_row <- nrow(lf_df)
lx <- rep(0,num_row)
lx[1] <- as.numeric(in_idata$population_number[in_idata$age == in_mid_age & in_idata$sex == in_sex])
# number died in year 1 simulation
dx <- rep(0,num_row)
dx[1] <- lx[1] * qx[1]
# number of survivors and who die from year 2 onwards.
for (i in 2:num_row){
lx[i] <- lx[i - 1] - dx[i - 1]
dx[i] <- lx[i] * qx[i]
}
# number of persons lived by cohort to age x + 1/2 (average people)
Lx <- rep(0,num_row)
# for years up to 99
for (i in 1:(num_row-1))
Lx[i] <- (lx[i] + lx[i + 1]) / 2
# for year 100, cohort dies at 100 if anyone left
Lx[num_row] <- lx[num_row] / lf_df$mx[num_row]
# create life expectancy variable
ex <- rep(0,num_row)
for (i in 1:num_row){
ex[i] <- sum(Lx[i:num_row]) / lx[i]
}
# create health adjusted life years variable
# Lwx <- Lx * (1 - lf_df$pyld_rate)
# create health adjusted life expectancy variable
# ewx <- rep(0,num_row)
# for (i in 1:num_row){
#   ewx[i] <- sum(Lwx[i:num_row]) / lx[i]
# }
lf_df$qx <- qx
lf_df$lx <- lx
lf_df$dx <- dx
lf_df$Lx <- Lx
lf_df$ex <- ex
# lf_df$Lwx <- Lwx
# lf_df$ewx <- ewx
lf_df
}
general_life_table_list_bl <- list()
index <- 1
for (iage in i_age_cohort){
for (isex in i_sex){
# cat('age ', age, ' and sex ', sex, '\n') #Uncomment to see index
suppressWarnings(general_life_table_list_bl[[index]] <- RunLifeTable(in_idata = LT_DF,
in_sex = isex, in_mid_age = iage))
names(general_life_table_list_bl)[index] <- paste(iage, isex, sep = '_')
index <- index + 1
}
}
View(general_life_table_list_bl)
general_life_table_list_sc <- list()
index <- 1
for (iage in i_age_cohort){
for (isex in i_sex){
td2 <- LT_DF
# td2 <- subset(td2, select = -c(mx, pyld_rate))
td2[td2$age >= iage & td2$sex == isex,][[paste('mx')]] <- general_life_table_list_bl[[index]]$mx * (1-0.05)
# Instead of idata, feed td to run scenarios
general_life_table_list_sc[[index]] <- RunLifeTable(in_idata = td2, in_sex = isex, in_mid_age = iage)
#
names(general_life_table_list_sc)[index] <- paste(iage, isex, sep = '_')
index <- index + 1
}
}
output_burden <- list()
l_index <- 1
l_sc_cols <- which(colnames(general_life_table_list_sc[[l_index]])%in%c('Lx', 'ex'))
l_bl_cols <- which(colnames(general_life_table_list_bl[[l_index]])%in%c('Lx', 'ex'))
l_index <- 1
for (iage in i_age_cohort){
for (isex in i_sex){
## general_life_table_list_sc and general_life_table_list_bl (Lx)
output_burden_lf_sc <- general_life_table_list_sc[[l_index]][,l_sc_cols]
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'Lx'] <- paste('Lx', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'Lwx'] <- paste('Lwx', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'ex'] <- paste('ex', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'ewx'] <- paste('ewx', 'sc', sep = '_')
output_burden_lf_bl <- general_life_table_list_bl[[l_index]][,l_bl_cols]
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'Lx'] <- paste('Lx', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'Lwx'] <- paste('Lwx', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ex'] <- paste('ex', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ewx'] <- paste('ewx', 'bl', sep = '_')
### Difference in life years and health adjusted life years for all evey cohort year
output_burden_lf_sc$Lx_diff <- general_life_table_list_sc[[l_index]]$Lx - general_life_table_list_bl[[l_index]]$Lx
output_burden_lf_sc$Lwx_diff <- general_life_table_list_sc[[l_index]]$Lwx - general_life_table_list_bl[[l_index]]$Lwx
### Difference in life expectancy and health adjusted life expectancy for first year of cohort (show in results)
output_burden_lf_sc$ex_diff <- general_life_table_list_sc[[l_index]]$ex - general_life_table_list_bl[[l_index]]$ex
output_burden_lf_sc$ewx_diff <- general_life_table_list_sc[[l_index]]$ewx - general_life_table_list_bl[[l_index]]$ewx
output_burden_sc <- cbind(output_burden_lf_bl, output_burden_lf_sc)
output_burden[[l_index]] <- output_burden_sc
names(output_burden)[l_index] <- paste(iage, isex, sep = '_')
l_index <- l_index + 1
}
}
for (iage in i_age_cohort){
for (isex in i_sex){
## general_life_table_list_sc and general_life_table_list_bl (Lx)
output_burden_lf_sc <- general_life_table_list_sc[[l_index]][,l_sc_cols]
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'Lx'] <- paste('Lx', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'ex'] <- paste('ex', 'sc', sep = '_')
output_burden_lf_bl <- general_life_table_list_bl[[l_index]][,l_bl_cols]
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'Lx'] <- paste('Lx', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ex'] <- paste('ex', 'bl', sep = '_')
### Difference in life years and health adjusted life years for all evey cohort year
output_burden_lf_sc$Lx_diff <- general_life_table_list_sc[[l_index]]$Lx - general_life_table_list_bl[[l_index]]$Lx
### Difference in life expectancy and health adjusted life expectancy for first year of cohort (show in results)
output_burden_lf_sc$ex_diff <- general_life_table_list_sc[[l_index]]$ex - general_life_table_list_bl[[l_index]]$ex
output_burden_sc <- cbind(output_burden_lf_bl, output_burden_lf_sc)
output_burden[[l_index]] <- output_burden_sc
names(output_burden)[l_index] <- paste(iage, isex, sep = '_')
l_index <- l_index + 1
}
}
output_df <- plyr::ldply(output_burden, rbind)
output_df <-  output_df  %>%
separate(.id, c("Age group", "Gender"), "_", remove = FALSE)
output_df$`Age group` <- as.numeric(output_df$`Age group`)
output_df$`Age group`[output_df$`Age group` == 17] <-"16-19"
output_df$`Age group`[output_df$`Age group` == 22] <-"20-24"
output_df$`Age group`[output_df$`Age group` == 27] <-"25-29"
output_df$`Age group`[output_df$`Age group` == 32] <-"30-34"
output_df$`Age group`[output_df$`Age group` == 37] <-"35-39"
output_df$`Age group`[output_df$`Age group` == 42] <-"40-44"
output_df$`Age group`[output_df$`Age group` == 47] <-"45-49"
output_df$`Age group`[output_df$`Age group` == 52] <-"50-54"
output_df$`Age group`[output_df$`Age group` == 57] <-"55-59"
output_df$`Age group`[output_df$`Age group` == 62] <-"60-64"
output_df$`Age group`[output_df$`Age group` == 67] <-"65-69"
output_df$`Age group`[output_df$`Age group` == 72] <-"70-74"
output_df$`Age group`[output_df$`Age group` == 77] <-"75-79"
output_df$`Age group`[output_df$`Age group` == 82] <-"80-84"
output_df$`Age group`[output_df$`Age group` == 87] <-"85-89"
output_df$`Age group`[output_df$`Age group` == 92] <-"90-94"
output_df$`Age group`[output_df$`Age group` == 97] <-"95 plus"
output_df$`Age group` <- as.numeric(output_df$`Age group`)
output_df <-  output_df  %>%
separate(.id, c("Age group", "Gender"), "_", remove = FALSE)
library(tidyr)
output_df <-  output_df  %>%
separate(.id, c("Age group", "Gender"), "_", remove = FALSE)
output_df$`Age group` <- as.numeric(output_df$`Age group`)
output_df$`Age group`[output_df$`Age group` == 17] <-"16-19"
output_df$`Age group`[output_df$`Age group` == 22] <-"20-24"
output_df$`Age group`[output_df$`Age group` == 27] <-"25-29"
output_df$`Age group`[output_df$`Age group` == 32] <-"30-34"
output_df$`Age group`[output_df$`Age group` == 37] <-"35-39"
output_df$`Age group`[output_df$`Age group` == 42] <-"40-44"
output_df$`Age group`[output_df$`Age group` == 47] <-"45-49"
output_df$`Age group`[output_df$`Age group` == 52] <-"50-54"
output_df$`Age group`[output_df$`Age group` == 57] <-"55-59"
output_df$`Age group`[output_df$`Age group` == 62] <-"60-64"
output_df$`Age group`[output_df$`Age group` == 67] <-"65-69"
output_df$`Age group`[output_df$`Age group` == 72] <-"70-74"
output_df$`Age group`[output_df$`Age group` == 77] <-"75-79"
output_df$`Age group`[output_df$`Age group` == 82] <-"80-84"
output_df$`Age group`[output_df$`Age group` == 87] <-"85-89"
output_df$`Age group`[output_df$`Age group` == 92] <-"90-94"
output_df$`Age group`[output_df$`Age group` == 97] <-"95 plus"
output_life_expectancy_change <- output_df[!duplicated(output_df$.id), c("Age group", "Gender", "ex_bl", "ex_sc",
"ex_diff")] %>%
dplyr::rename(`Life expectancy at baseline` = ex_bl,
`Life expectancy scenario` = ex_sc,
`Health adjusted life expectancy baseline` = ewx_bl,
`Health adjusted life expectancy scenario` = ewx_sc,
`Difference in life expectancy` = ex_diff,
`Difference in health adjusted life expectancy` = ewx_diff) %>%
mutate_if(is.numeric, round, digits = 3)
output_life_expectancy_change <- output_df[!duplicated(output_df$.id), c("Age group", "Gender", "ex_bl", "ex_sc",
"ex_diff")] %>%
dplyr::rename(`Life expectancy at baseline` = ex_bl,
`Life expectancy scenario` = ex_sc,
`Difference in life expectancy` = ex_diff) %>%
mutate_if(is.numeric, round, digits = 3)
output_life_expectancy_change <- output_life_expectancy_change[order(output_life_expectancy_change$Gender),]
View(output_life_expectancy_change)
output_life_years_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, Lx_diff) %>%
dplyr::rename(`Life years` = Lx_diff)  %>%
mutate_if(is.numeric, round)
View(output_life_years_change)
output_burden <- list()
l_index <- 1
l_sc_cols <- which(colnames(general_life_table_list_sc[[l_index]])%in%c('Lx', 'ex', 'dx'))
l_bl_cols <- which(colnames(general_life_table_list_bl[[l_index]])%in%c('Lx', 'ex', 'dx'))
for (iage in i_age_cohort){
for (isex in i_sex){
## general_life_table_list_sc and general_life_table_list_bl (Lx)
output_burden_lf_sc <- general_life_table_list_sc[[l_index]][,l_sc_cols]
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'Lx'] <- paste('Lx', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'ex'] <- paste('ex', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'dx'] <- paste('dx', 'sc', sep = '_')
output_burden_lf_bl <- general_life_table_list_bl[[l_index]][,l_bl_cols]
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'Lx'] <- paste('Lx', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ex'] <- paste('ex', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ex'] <- paste('dx', 'bl', sep = '_')
### Difference in life years for each year of the cohort
output_burden_lf_sc$Lx_diff <- general_life_table_list_sc[[l_index]]$Lx - general_life_table_list_bl[[l_index]]$Lx
### Difference in life expectancy, we only report for first year
output_burden_lf_sc$ex_diff <- general_life_table_list_sc[[l_index]]$ex - general_life_table_list_bl[[l_index]]$ex
### Difference in deaths for each year of the cohort
output_burden_lf_sc$dx_diff <- general_life_table_list_sc[[l_index]]$dx - general_life_table_list_bl[[l_index]]$dx
output_burden_sc <- cbind(output_burden_lf_bl, output_burden_lf_sc)
output_burden[[l_index]] <- output_burden_sc
names(output_burden)[l_index] <- paste(iage, isex, sep = '_')
l_index <- l_index + 1
}
}
output_df <- plyr::ldply(output_burden, rbind)
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, ex_diff) %>%
dplyr::rename(`Life years` = ex_diff)  %>%
mutate_if(is.numeric, round)
output_df <-  output_df  %>%
separate(.id, c("Age group", "Gender"), "_", remove = FALSE)
output_df$`Age group` <- as.numeric(output_df$`Age group`)
output_df$`Age group`[output_df$`Age group` == 17] <-"16-19"
output_df$`Age group`[output_df$`Age group` == 22] <-"20-24"
output_df$`Age group`[output_df$`Age group` == 27] <-"25-29"
output_df$`Age group`[output_df$`Age group` == 32] <-"30-34"
output_df$`Age group`[output_df$`Age group` == 37] <-"35-39"
output_df$`Age group`[output_df$`Age group` == 42] <-"40-44"
output_df$`Age group`[output_df$`Age group` == 47] <-"45-49"
output_df$`Age group`[output_df$`Age group` == 52] <-"50-54"
output_df$`Age group`[output_df$`Age group` == 57] <-"55-59"
output_df$`Age group`[output_df$`Age group` == 62] <-"60-64"
output_df$`Age group`[output_df$`Age group` == 67] <-"65-69"
output_df$`Age group`[output_df$`Age group` == 72] <-"70-74"
output_df$`Age group`[output_df$`Age group` == 77] <-"75-79"
output_df$`Age group`[output_df$`Age group` == 82] <-"80-84"
output_df$`Age group`[output_df$`Age group` == 87] <-"85-89"
output_df$`Age group`[output_df$`Age group` == 92] <-"90-94"
output_df$`Age group`[output_df$`Age group` == 97] <-"95 plus"
### Life expectancy
### Life expectancy is for year one of simulation. For example, change in life expectancy for a female aged 16-19.
output_life_expectancy_change <- output_df[!duplicated(output_df$.id), c("Age group", "Gender", "ex_bl", "ex_sc",
"ex_diff")] %>%
dplyr::rename(`Life expectancy at baseline` = ex_bl,
`Life expectancy scenario` = ex_sc,
`Difference in life expectancy` = ex_diff) %>%
mutate_if(is.numeric, round, digits = 3)
output_life_expectancy_change <- output_life_expectancy_change[order(output_life_expectancy_change$Gender),]
### Life years
#### Accumulated over the life of the cohort. For example, total life years change for females 16-19 over their life course
output_life_years_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, Lx_diff) %>%
dplyr::rename(`Life years` = Lx_diff)  %>%
mutate_if(is.numeric, round)
### Deaths
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, ex_diff) %>%
dplyr::rename(`Life years` = ex_diff)  %>%
mutate_if(is.numeric, round)
View(output_deaths_change)
View(output_df)
### Deaths
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, dx_diff) %>%
dplyr::rename(`Deaths` = dx_diff)  %>%
mutate_if(is.numeric, round)
View(output_deaths_change)
output_burden <- list()
l_index <- 1
l_sc_cols <- which(colnames(general_life_table_list_sc[[l_index]])%in%c('Lx', 'ex', 'dx'))
l_bl_cols <- which(colnames(general_life_table_list_bl[[l_index]])%in%c('Lx', 'ex', 'dx'))
for (iage in i_age_cohort){
for (isex in i_sex){
## general_life_table_list_sc and general_life_table_list_bl (Lx)
output_burden_lf_sc <- general_life_table_list_sc[[l_index]][,l_sc_cols]
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'Lx'] <- paste('Lx', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'ex'] <- paste('ex', 'sc', sep = '_')
names(output_burden_lf_sc)[names(output_burden_lf_sc) == 'dx'] <- paste('dx', 'sc', sep = '_')
output_burden_lf_bl <- general_life_table_list_bl[[l_index]][,l_bl_cols]
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'Lx'] <- paste('Lx', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'ex'] <- paste('ex', 'bl', sep = '_')
names(output_burden_lf_bl)[names(output_burden_lf_bl) == 'dx'] <- paste('dx', 'bl', sep = '_')
### Difference in life years for each year of the cohort
output_burden_lf_sc$Lx_diff <- general_life_table_list_sc[[l_index]]$Lx - general_life_table_list_bl[[l_index]]$Lx
### Difference in life expectancy, we only report for first year
output_burden_lf_sc$ex_diff <- general_life_table_list_sc[[l_index]]$ex - general_life_table_list_bl[[l_index]]$ex
### Difference in deaths for each year of the cohort
output_burden_lf_sc$dx_diff <- general_life_table_list_sc[[l_index]]$dx - general_life_table_list_bl[[l_index]]$dx
output_burden_sc <- cbind(output_burden_lf_bl, output_burden_lf_sc)
output_burden[[l_index]] <- output_burden_sc
names(output_burden)[l_index] <- paste(iage, isex, sep = '_')
l_index <- l_index + 1
}
}
## Generate a data frame for all results
output_df <- plyr::ldply(output_burden, rbind)
### Create some tables
output_df <-  output_df  %>%
separate(.id, c("Age group", "Gender"), "_", remove = FALSE)
output_df$`Age group` <- as.numeric(output_df$`Age group`)
output_df$`Age group`[output_df$`Age group` == 17] <-"16-19"
output_df$`Age group`[output_df$`Age group` == 22] <-"20-24"
output_df$`Age group`[output_df$`Age group` == 27] <-"25-29"
output_df$`Age group`[output_df$`Age group` == 32] <-"30-34"
output_df$`Age group`[output_df$`Age group` == 37] <-"35-39"
output_df$`Age group`[output_df$`Age group` == 42] <-"40-44"
output_df$`Age group`[output_df$`Age group` == 47] <-"45-49"
output_df$`Age group`[output_df$`Age group` == 52] <-"50-54"
output_df$`Age group`[output_df$`Age group` == 57] <-"55-59"
output_df$`Age group`[output_df$`Age group` == 62] <-"60-64"
output_df$`Age group`[output_df$`Age group` == 67] <-"65-69"
output_df$`Age group`[output_df$`Age group` == 72] <-"70-74"
output_df$`Age group`[output_df$`Age group` == 77] <-"75-79"
output_df$`Age group`[output_df$`Age group` == 82] <-"80-84"
output_df$`Age group`[output_df$`Age group` == 87] <-"85-89"
output_df$`Age group`[output_df$`Age group` == 92] <-"90-94"
output_df$`Age group`[output_df$`Age group` == 97] <-"95 plus"
### Life expectancy
### Life expectancy is for year one of simulation. For example, change in life expectancy for a female aged 16-19.
output_life_expectancy_change <- output_df[!duplicated(output_df$.id), c("Age group", "Gender", "ex_bl", "ex_sc",
"ex_diff")] %>%
dplyr::rename(`Life expectancy at baseline` = ex_bl,
`Life expectancy scenario` = ex_sc,
`Difference in life expectancy` = ex_diff) %>%
mutate_if(is.numeric, round, digits = 3)
output_life_expectancy_change <- output_life_expectancy_change[order(output_life_expectancy_change$Gender),]
### Life years
#### Accumulated over the life of the cohort. For example, total life years change for females 16-19 over their life course
output_life_years_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, Lx_diff) %>%
dplyr::rename(`Life years` = Lx_diff)  %>%
mutate_if(is.numeric, round)
### Deaths
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, dx_diff) %>%
dplyr::rename(`Deaths` = dx_diff)  %>%
mutate_if(is.numeric, round)
View(output_deaths_change)
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, dx_diff)
View(output_deaths_change)
output_deaths_change <- output_df %>%
group_by(Gender, `Age group`) %>%
summarise_if(is.numeric, funs(sum)) %>%
dplyr::select(`Age group`, Gender, dx_diff) %>%
dplyr::rename(`Deaths` = dx_diff)
View(output_df)
View(output_life_years_change)
