if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
require(dplyr)
require(dplyr)
require(tidyverse)
library(dplyr)
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(stringr::str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn))
browser()
if (nrow(idf) > 0){
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0))
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(stringr::str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn))
browser()
if (nrow(idf) > 0){
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0))
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(stringr::str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn))
browser()
if (nrow(idf) > 0){
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0))
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
require(dplyr)
require(tidyverse)
require(knitr)
require(kableExtra)
require(citr)
require(gridExtra)
require(ggpubr)
require(grid)
require(ggplot2)
require(devtools)
require(janitor)
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(stringr::str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn))
browser()
if (nrow(idf) > 0){
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0))
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(stringr::str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn))
browser()
}}}}
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn)
}}}}
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data["age"])[ag]
idf <- dplyr::filter(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn)
if (nrow(idf) > 0){
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- dplyr::filter(str_detect(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0))
idf <- dplyr::filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- dplyr::filter(idf, metric == "Number") %>% select("val")
idf_rate <- dplyr::filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- dplyr::filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
RunLocDf <- function(i_data) {
gbd_df <- NULL
for (ag in 1:length(unique(i_data$age))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data$age)[ag]
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn)
if (nrow(idf) > 0){
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0)
idf <- filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
return(gbd_df)
}
test <- lapply(test_cr, RunLocDf)
c
c
Q
RunLocDf <- function(i_data) {
gbd_df <- NULL
for (ag in 1:length(unique(i_data["age"]))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data$age)[ag]
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn)
if (nrow(idf) > 0){
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0)
idf <- filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
return(gbd_df)
}
test <- lapply(test_cr, RunLocDf)
RunLocDf <- function(i_data) {
gbd_df <- NULL
for (ag in 1:length(unique(i_data['age']))){
for (gender in c("Male", "Female")){
age_sex_df <- NULL
for (dm in 1:length(disease_measures_list)){
for (d in 1:nrow(disease_short_names)){
dn <- disease_short_names$disease[d]
dmeasure <- disease_measures_list[dm] %>% as.character()
agroup <- unique(i_data['age'])[ag]
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & cause == dn)
if (nrow(idf) > 0){
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
else{
current_idf_rate <- idf_rate
current_population_numbers <- population_numbers
idf <- filter(i_data, sex == gender & age == agroup & measure == dmeasure & val > 0)
idf <- filter(idf, cause == unique(idf$cause)[1])
idf$cause <- dn
population_numbers <- filter(idf, metric == "Number") %>% select("val")
idf_rate <- filter(idf, metric == "Rate") %>% select("val")
idf$population_number <- 0
if (idf_rate$val != 0 && population_numbers$val != 0)
idf$population_number <- (100000 * population_numbers$val) / idf_rate$val
}
idf$rate_per_1 <- round(current_idf_rate$val / 100000, 6)
idf[[tolower(paste(dmeasure, "rate", disease_short_names$sname[d], sep = "_"))]] <- idf$rate_per_1
idf[[tolower(paste(dmeasure, "number", disease_short_names$sname[d], sep = "_"))]] <- current_population_numbers$val
idf <- filter(idf, metric == "Number")
if (is.null(age_sex_df)){
age_sex_df <- select(idf, age, sex, population_number, location, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)])
}
else{
age_sex_df <- cbind(age_sex_df, select(idf, names(idf)[ncol(idf) - 1] , names(idf)[ncol(idf)]))
}
}
}
}
if (is.null(gbd_df)){
gbd_df <- age_sex_df
}
else{
age_sex_df[setdiff(names(gbd_df), names(age_sex_df))] <- 0
gbd_df[setdiff(names(age_sex_df), names(gbd_df))] <- 0
gbd_df <- rbind(gbd_df, age_sex_df)
}
}
}
return(gbd_df)
}
test <- lapply(test_cr, RunLocDf)
test <- lapply(test_cr, RunLocDf)
test_cr <- gbd_data_loc_raw_city_regions[[1]]
test <- lapply(test_cr, RunLocDf)
write_csv(test_cr, "data/test_cr.csv")
test <- lapply(test_cr, RunLocDf)
